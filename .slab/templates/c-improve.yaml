name: c-improve
command: /c-improve
description: Refactor C code to safer, more robust C following MISRA/CERT standards
prompt: |
  Refactor the attached C code into safer, more robust C.

  Requirements:
  1. Use fixed-width types (stdint.h) - uint32_t, int64_t, size_t, etc.
  2. Add explicit error handling with enum return codes
  3. Remove all static/global state - pass context explicitly
  4. Add const correctness for all read-only parameters
  5. Add restrict keywords for non-aliasing pointers
  6. Add NULL pointer checks at function entry
  7. Add bounds checking for array accesses
  8. Use bool from stdbool.h instead of int flags
  9. Add comprehensive function documentation
  10. Keep cyclomatic complexity < 10
  11. Maximum function length: 50 lines
  12. MAINTAIN PERFORMANCE - no heap allocations in hot paths

  Target standards: MISRA C:2012, CERT C

  IMPORTANT: Output the COMPLETE refactored file inside a fenced code block
  annotated with the target file path using this exact format:

  ```c:/path/to/the/original/file.c
  // complete refactored code here
  ```

  Use the exact path of the source file provided in context. The path after
  the colon is critical — it tells the system which file to create or
  overwrite. You MUST include every line of the file, not just changed
  sections. Do NOT omit any code or use "// ... rest unchanged" placeholders.

  Then output the function mapping as a second fenced code block written to
  .slab/reports/function-map.md using this exact format:

  ```md:.slab/reports/function-map.md
  # Function Mapping: [source file name]

  | Old Function | New Function(s) | Change |
  |---|---|---|
  | `old_fn()` | `new_fn_a()`, `new_fn_b()` | Split — reason |
  | `old_fn()` | `renamed_fn()` | Renamed — reason |
  | *(none)* | `new_fn()` | Added — reason |
  | `old_fn()` | *(removed)* | Removed — reason |
  ```

  Only include functions that were structurally changed (split, merged, renamed, added, or removed).
  Do NOT list functions that only had type annotations or safety checks added — those are implicit.
  Keep reasons to one short phrase.

  {{files}}

# After the LLM improves the code, run static analysis and loop back if issues are found.
# Swap "cppcheck" for "gcc -Wall -Wextra -o /dev/null" or "clang-tidy" as needed.
phases:
  - name: "static analysis"
    run: "cppcheck --enable=all --error-exitcode=1 {{file}}"
    on_success: stop
    on_failure: continue
